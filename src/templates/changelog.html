<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="changelog.title"></title>
  <link rel="stylesheet" href="../styles/modules/info.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css" />
  <script src="../renderer/i18n.js"></script>
  <style>
    .changelog-content {
      text-align: left;
      max-width: 800px;
      margin: 0 auto;
      padding: 0 20px;
      font-size: 12px;
      line-height: 1.5;
    }

    .changelog-content h2 {
      margin-top: 1.5em;
      font-size: 1.2em;
      padding-bottom: 0.3em;
      border-bottom: 1px solid #eaecef;
    }

    .changelog-content h3 {
      margin-top: 1.2em;
      font-size: 1.1em;
    }

    .changelog-content p,
    .changelog-content li {
      font-size: 12px;
      margin: 0.5em 0;
    }

    .changelog-content ul {
      padding-left: 2em;
    }

    .changelog-content li {
      margin: 0.5em 0;
    }

    .version-date {
      color: #6a737d;
      font-size: 0.9em;
      margin-left: 1em;
      font-weight: normal;
    }

    .load-more {
      text-align: center;
      margin: 1.5rem 0;
      font-style: italic;
      color: #1e88e5;
      cursor: pointer;
    }

    .load-more:hover {
      text-decoration: underline;
    }

    .lang-link {
      color: #666;
      text-decoration: none;
      font-weight: normal;
    }

    .lang-link.active {
      color: #1e88e5;
      font-weight: bold;
    }

    .changelog-item {
      margin-bottom: 2rem;
    }

    .changelog-item.hidden {
      display: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="logo">
      <img src="../assets/logo/app-logo-512.png" alt="NoteWizard" />
    </div>
    <h1 data-i18n="changelog.title"></h1>
    <div id="changelog-container" class="changelog-content markdown-body">
      <span data-i18n="changelog.loading"></span>
    </div>
  </div>

  <script>
    // 配置常量
    const CONFIG = {
      LANGUAGE_EN_US: 'en-US',
      LANGUAGE_ZH_CN: 'zh-CN',
      MAX_VISIBLE_ITEMS: 3,
      MARKED_URL: 'https://cdn.jsdelivr.net/npm/marked/marked.min.js'
    };

    // 主应用类
    class ChangelogApp {
      constructor() {
        this.changelogContainer = document.getElementById('changelog-container');
        this.currentLang = this.detectCurrentLanguage();
      }

      // 初始化应用
      async init() {
        try {
          await this.loadDependencies();
          await this.loadChangelog(this.currentLang);
        } catch (error) {
          this.showError(t('changelog.errors.initializationFailed'));
        }
      }

      // 检测当前语言
      detectCurrentLanguage() {
        const currentLang = window.i18n?.currentLanguage || 
                            localStorage.getItem('lang') || 
                            navigator.language;
          
        return (currentLang && currentLang.startsWith('zh')) 
          ? CONFIG.LANGUAGE_ZH_CN 
          : CONFIG.LANGUAGE_EN_US;
      }

      // 加载依赖
      loadDependencies() {
        return new Promise((resolve, reject) => {
          if (typeof marked !== 'undefined') {
            resolve();
            return;
          }
          const script = document.createElement('script');
          script.src = CONFIG.MARKED_URL;
          script.onload = () => resolve();
          document.head.appendChild(script);
        });
      }

      // 加载更新日志
      async loadChangelog(lang) {
        try {
          const markdown = window.require('fs').readFileSync(
            window.require('path').join(__dirname, '..', 'assets', 'changelog',
              `history_${lang === CONFIG.LANGUAGE_EN_US ? 'en' : 'cn'}.md`
            ),
            'utf-8'
          );
          this.renderMarkdown(markdown);

        } catch (error) {
          this.showError(t('changelog.errors.loadFailed'));
        }
      }

      // 渲染Markdown内容
      renderMarkdown(markdown) {
        // 配置marked
        marked.setOptions({
          gfm: true,
          breaks: true,
          sanitize: false
        });

        // 渲染HTML
        const renderedHtml = marked.parse(markdown);
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = renderedHtml;

        // 清空容器
        this.changelogContainer.innerHTML = '';

        // 处理日志项
        this.processLogItems(tempDiv);
      }

      // 处理日志项
      processLogItems(container) {
        const items = [];
        let currentItem = null;
        const versionRegex = /^\[?v?\d+\.\d+\.\d+\]?/;

        // 遍历所有节点
        Array.from(container.childNodes).forEach(node => {
          const isVersionHeader = node.nodeType === 1 &&
            node.tagName === 'H3' &&
            node.textContent.trim().match(versionRegex);

          if (isVersionHeader) {
            currentItem = document.createElement('div');
            currentItem.className = 'changelog-item';
            items.push(currentItem);
            this.changelogContainer.appendChild(currentItem);
          }

          // 将节点添加到当前项或直接添加到容器
          const target = currentItem || this.changelogContainer;
          target.appendChild(node);
        });

        // 处理显示/隐藏项
        this.handleItemVisibility(items);
      }

      // 处理项目可见性
      handleItemVisibility(items) {
        // 隐藏超出最大显示数量的项
        items.forEach((item, index) => {
          if (index >= CONFIG.MAX_VISIBLE_ITEMS) {
            item.classList.add('hidden');
          }
        });

        // 如果有多余项，添加"加载更多"按钮
        if (items.length > CONFIG.MAX_VISIBLE_ITEMS) {
          this.addLoadMoreButton();
        }
      }

      // 添加"加载更多"按钮
      addLoadMoreButton() {
        const loadMoreLink = document.createElement('a');
        loadMoreLink.href = '#';
        loadMoreLink.className = 'load-more-link';
        loadMoreLink.textContent = t('changelog.loadMore');
        loadMoreLink.addEventListener('click', (e) => {
          e.preventDefault();
          document.querySelectorAll('.changelog-item.hidden').forEach(item => {
            item.classList.remove('hidden');
          });
          loadMoreLink.remove();
        });

        const loadMoreDiv = document.createElement('div');
        loadMoreDiv.className = 'load-more';
        loadMoreDiv.appendChild(loadMoreLink);
        this.changelogContainer.appendChild(loadMoreDiv);
      }

      // 显示错误信息
      showError(message) {
        this.changelogContainer.textContent = message;
      }
    }

    // 初始化应用
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await initI18n();
        applyI18n();

        const app = new ChangelogApp();
        await app.init();
      } catch (error) {
        document.getElementById('changelog-container').textContent = t('changelog.errors.initializationFailed');
      }
    });
  </script>
</body>

</html>